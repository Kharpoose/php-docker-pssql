<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒãƒˆãƒ«ç”»é¢</title>
<link rel="stylesheet" href="battle.css" />
 
</head>
 
 
<body>
    <h2 class = "title">ãƒãƒˆãƒ«é–‹å§‹ï¼</h2>
    <div class="battle-container">
        <div class="panel" id="playerPanel">
            <h3>è‡ªåˆ†ã®ãƒã‚±ãƒ¢ãƒ³</h3>
            <p><strong>åå‰:</strong> <span id="p_name"></span></p>
            <p><strong>å±æ€§:</strong> <span id="p_type"></span></p>
            <p><strong>HP:</strong> <span id="p_hp"></span></p>
            <p><strong>ã‚¨ãƒãƒ«ã‚®ãƒ¼:</strong> <span id="p_energy"></span></p>
            <!-- ä¾‹ï¼šè‡ªåˆ†ã®ãƒã‚±ãƒ¢ãƒ³ãƒ‘ãƒãƒ«å†… -->
            <img id="playerImage" src="" alt="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒã‚±ãƒ¢ãƒ³" style="width: 150px; height: auto;">
            <button id="attack1"></button>
            <button id="attack2"></button>
            <button id="pass">Pass</button>
        </div>
 
        <div class="panel" id="botPanel">
            <h3>æ•µã®ãƒã‚±ãƒ¢ãƒ³</h3>
            <p><strong>åå‰:</strong> <span id="b_name"></span></p>
            <p><strong>å±æ€§:</strong> <span id="b_type"></span></p>
            <p><strong>HP:</strong> <span id="b_hp"></span></p>
            <img id="botImage" src="" alt="æ•µã®ãƒã‚±ãƒ¢ãƒ³" style="width: 150px; height: auto;">
        </div>
    </div>
   
    <script>
        // æ—¢å­˜ã® JavaScript ã‚³ãƒ¼ãƒ‰ã¯ãã®ã¾ã¾ã§OK
        const player = JSON.parse(sessionStorage.getItem('selectedPokemon'));
        player.energy = 3;
        let isPlayerTurnFirst = Math.random() < 0.5; // trueãªã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…ˆè¡Œã€falseãªã‚‰ãƒœãƒƒãƒˆå…ˆè¡Œ
 
        let bot = null;
 
        function renderPlayer() {
            document.getElementById('p_name').textContent = player.name;
            document.getElementById('p_type').textContent = player.type;
            document.getElementById('p_hp').textContent = player.hp;
            document.getElementById('p_energy').textContent = player.energy;
 
            document.getElementById('attack1').textContent = `${player.attack_1_name} (${player.attack_1_damage} dmg / ${player.attack_1_energy} enerji)`;
            document.getElementById('attack2').textContent = `${player.attack_2_name} (${player.attack_2_damage} dmg / ${player.attack_2_energy} enerji)`;
 
            //å±æ€§ã«åŸºã¥ããƒœã‚¿ãƒ³è‰²å¤‰æ›´
            setButtonColors(player.type);
 
              // ğŸ’¡ ç”»åƒã‚’è¡¨ç¤º
            if (player.image_url) {
                document.getElementById('playerImage').src = player.image_url;
            }
        }
 
        function setButtonColors(type) {
            const attack1Button = document.getElementById('attack1');
            const attack2Button = document.getElementById('attack2');
            const passButton = document.getElementById('pass');
 
            // å±æ€§ã«åŸºã¥ã„ã¦è‰²ã‚’è¨­å®š
            switch(type) {
                case 'ã»ã®ãŠ':
                    attack1Button.style.backgroundColor = '#FF5733'; // èµ¤
                    attack2Button.style.backgroundColor = '#FF5733'; // èµ¤
                    passButton.style.backgroundColor = '#FF5733';    // èµ¤
                    break;
                case 'ã¿ãš':
                    attack1Button.style.backgroundColor = '#1E90FF'; // é’
                    attack2Button.style.backgroundColor = '#1E90FF'; // é’
                    passButton.style.backgroundColor = '#1E90FF';    // é’
                    break;
                case 'ãã•':
                    attack1Button.style.backgroundColor = '#228B22'; // ç·‘
                    attack2Button.style.backgroundColor = '#228B22'; // ç·‘
                    passButton.style.backgroundColor = '#228B22';    // ç·‘
                    break;
                case 'ã§ã‚“ã':
                    attack1Button.style.backgroundColor = '#FFD700'; // é»„è‰²
                    attack2Button.style.backgroundColor = '#FFD700'; // é»„è‰²
                    passButton.style.backgroundColor = '#FFD700';    // é»„è‰²
                    break;
                default:
                    attack1Button.style.backgroundColor = '#ffcb05'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    attack2Button.style.backgroundColor = '#ffcb05'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                    passButton.style.backgroundColor = '#ffcb05';    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            }
        }
 
        function renderBot() {
            document.getElementById('b_name').textContent = bot.name;
            document.getElementById('b_type').textContent = bot.type;
            document.getElementById('b_hp').textContent = bot.hp;
            // ğŸ’¡ ç”»åƒã‚’è¨­å®š
            if (bot.image_url) {
                document.getElementById('botImage').src = bot.image_url;
            }
            if (!bot.image_url) {
                bot.image_url = getImageUrl(bot.name);
            }
            document.getElementById('botImage').src = bot.image_url;
 
        }
 
        function getImageUrl(name) {
            const imageMap = {
                "ãƒªã‚¶ãƒ¼ãƒ‰ãƒ³": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/6.png",
                "ãƒã‚·ãƒ£ãƒ¼ãƒ¢": "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/257.png",
                "ã‚¦ã‚¤ãƒ³ãƒ‡ã‚£" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/59.png",
                "ãƒ•ã‚¡ã‚¤ãƒ¤ãƒ¼" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/146.png",
                "ã‚¨ãƒ¼ã‚¹ãƒãƒ¼ãƒ³" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/815.png",
                "ã‚«ãƒ¡ãƒƒã‚¯ã‚¹" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/9.png",
                "ã‚·ãƒ£ãƒ¯ãƒ¼ã‚º" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/134.png",
                "ãƒ©ã‚°ãƒ©ãƒ¼ã‚¸" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/260.png",
                "ã‚²ãƒƒã‚³ã‚¦ã‚¬" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/658.png",
                "ãƒŸãƒ­ã‚«ãƒ­ã‚¹" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/350.png",
                "ãƒ•ã‚·ã‚®ãƒãƒŠ" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/3.png",
                "ã‚¸ãƒ¥ã‚«ã‚¤ãƒ³" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/254.png",
                "ãƒŠãƒƒã‚·ãƒ¼" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/103.png",
                "ãƒ­ã‚ºãƒ¬ã‚¤ãƒ‰" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/407.png",
                "ã‚´ãƒªãƒ©ãƒ³ãƒ€ãƒ¼" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/812.png",
                "ãƒ”ã‚«ãƒãƒ¥ã‚¦" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png",
                "ãƒ©ã‚¤ãƒãƒ¥ã‚¦" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/26.png",
                "ã‚µãƒ³ãƒ€ãƒ¼ã‚¹" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/135.png",
                "ã‚¨ãƒ¬ã‚­ãƒ–ãƒ«" : "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/466.png",
                "ãƒ‡ãƒ³ãƒªãƒ¥ã‚¦" : "https://img.pokemondb.net/artwork/large/ampharos.jpg"
              };
            return imageMap[name] || '';
        }
 
 
        function updateStats() {
            document.getElementById('p_hp').textContent = player.hp;
            document.getElementById('p_energy').textContent = player.energy;
            document.getElementById('b_hp').textContent = bot.hp;
        }
 
        function checkEndGame() {
            if (bot.hp <= 0) {
                alert("å‹åˆ©! ğŸ‰");
                disableButtons();
                saveBattleResult("å‹åˆ©", player, bot);
                console.log('ç”»é¢é·ç§»å‰ï¼šå‹åˆ©');
                location.href = 'result.html';  //çµæœç”»é¢ã¸
            } else if (player.hp <= 0) {
                alert("è² ã‘! ğŸ˜¢");
                saveBattleResult("è² ã‘", player, bot);
                disableButtons();
                console.log('ç”»é¢é·ç§»å‰ï¼šè² ã‘');
                location.href = 'result.html'; //çµæœç”»é¢ã¸
            }
        }
 
        function disableButtons() {
            document.getElementById('attack1').disabled = true;
            document.getElementById('attack2').disabled = true;
            document.getElementById('pass').disabled = true;
        }
 
        function botTurn() {
            bot.energy += 1;
 
            const attacks = [
                {
                    name: bot.attack_1_name,
                    damage: parseInt(bot.attack_1_damage),
                    energy: parseInt(bot.attack_1_energy),
                },
                {
                    name: bot.attack_2_name,
                    damage: parseInt(bot.attack_2_damage),
                    energy: parseInt(bot.attack_2_energy),
                }
            ];
 
            const possibleAttacks = attacks.filter(a => bot.energy >= a.energy);
 
            if (possibleAttacks.length > 0) {
                const attack = possibleAttacks[Math.floor(Math.random() * possibleAttacks.length)];
                alert(`ç›¸æ‰‹ã® ${bot.name}ãŒ${attack.name} ãŒæ”»æ’ƒã—ã¦ããŸ!`);
                if(player.type == 'ãã•' && bot.type ==  'ã»ã®ãŠ' ||
                    player.type == 'ã§ã‚“ã' && bot.type ==  'ãã•' ||
                    player.type == 'ã¿ãš' && bot.type ==  'ã§ã‚“ã' ||
                    player.type == 'ã»ã®ãŠ' && bot.type ==  'ã¿ãš' ){
                       
                    bot.energy -= attack.energy;
                    player.hp -= attack.damage+10;
                }else{
                    bot.energy -= attack.energy;
                    player.hp -= attack.damage;
                }
            } else {
                alert(`ç›¸æ‰‹ã® ${bot.name} ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’2å¾—ãŸ`);
                bot.energy += 2;
            }
 
            renderPlayer();
            renderBot();
            checkEndGame();
        }
 
        fetch('get_pokemon.php') // nameãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’çœç•¥ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ ã«ãƒã‚±ãƒ¢ãƒ³ã‚’é¸æŠ
          .then(res => res.json())
          .then(data => {
            console.log('å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:', data);  // å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›
            if (data.length > 0) {
                const randomIndex = Math.floor(Math.random() * data.length);
                bot = data[randomIndex];  // ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒã‚±ãƒ¢ãƒ³ã‚’é¸æŠ
                bot.energy = 3;           // ãƒœãƒƒãƒˆã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’3ã«è¨­å®š
                renderPlayer();           // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒã‚±ãƒ¢ãƒ³ã‚’è¡¨ç¤º
                renderBot();              // ãƒœãƒƒãƒˆã®ãƒã‚±ãƒ¢ãƒ³ã‚’è¡¨ç¤º
 
                // å…ˆè¡Œãƒ»å¾Œæ”»ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«æ±ºå®šã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ
                isPlayerTurnFirst = Math.random() < 0.5;
                startBattleTurn();
            } else {
                alert('ãƒœãƒƒãƒˆãƒã‚±ãƒ¢ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            }
          })
        .catch(err => {
            alert('ãƒœãƒƒãƒˆã®ãƒã‚±ãƒ¢ãƒ³ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ.');
            console.error('ã‚¨ãƒ©ãƒ¼å†…å®¹:', err);
        });
 
        document.getElementById('attack1').onclick = function () {
            if (player.energy >= player.attack_1_energy) {
                alert(`${player.attack_1_name} ã§æ”»æ’ƒã—ãŸï¼`);
                if(player.type == 'ã»ã®ãŠ' && bot.type ==  'ãã•' ||
                player.type == 'ãã•' && bot.type ==  'ã§ã‚“ã' ||
                player.type == 'ã§ã‚“ã' && bot.type ==  'ã¿ãš' ||
                player.type == 'ã¿ãš' && bot.type ==  'ã»ã®ãŠ' ){
                    player.energy -= parseInt(player.attack_1_energy);
                    bot.hp -= parseInt(player.attack_1_damage+10);
                    player.energy += 1;
                    updateStats();
                    checkEndGame();
                    if (bot.hp > 0) botTurn();
                   
                }else{
 
                    player.energy -= parseInt(player.attack_1_energy);
                    bot.hp -= parseInt(player.attack_1_damage);
                    player.energy += 1;
                    updateStats();
                    checkEndGame();
                    if (bot.hp > 0) botTurn();
                }
            } else {
                alert("ååˆ†ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ï¼");
            }
        };
 
        document.getElementById('attack2').onclick = function () {
            if (player.energy >= player.attack_2_energy) {
                alert(`${player.attack_2_name} ã§æ”»æ’ƒã—ãŸï¼`);
                if(player.type == 'ã»ã®ãŠ' && bot.type ==  'ãã•' ||
                    player.type == 'ãã•' && bot.type ==  'ã§ã‚“ã' ||
                    player.type == 'ã§ã‚“ã' && bot.type ==  'ã¿ãš' ||
                    player.type == 'ã¿ãš' && bot.type ==  'ã»ã®ãŠ' ){
                       
                        player.energy -= parseInt(player.attack_2_energy);
                        bot.hp -= parseInt(player.attack_2_damage+10);
                        player.energy += 1;
                        updateStats();
                        checkEndGame();
                        if (bot.hp > 0) botTurn();
                       
                    }else{
 
                        player.energy -= parseInt(player.attack_2_energy);
                        bot.hp -= parseInt(player.attack_2_damage);
                        player.energy += 1;
                        updateStats();
                        checkEndGame();
                        if (bot.hp > 0) botTurn();
                    }
            }else {
                alert("ååˆ†ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ï¼");
            }
        };
 
        document.getElementById('pass').onclick = function () {
            alert("ãƒ‘ã‚¹ã—ãŸã€‚ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’2ç²å¾—ã—ãŸã€‚");
            player.energy += 2;
            updateStats();
            botTurn();
        };
 
       
        // ãƒãƒˆãƒ«çµæœã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
        function saveBattleResult(resultMessage, player, bot) {
            const resultData = {
                resultMessage: resultMessage,
                player: {
                    name: player.name,
                    hp: player.hp,
                    maxHp: player.maxHp,
                    imageUrl: player.image_url
                },
                bot: {
                    name: bot.name,
                    hp: bot.hp,
                    maxHp: bot.maxHp,
                    imageUrl: bot.image_url
                }
            };
 
            // è¿½åŠ : ä¿å­˜å¾Œã«å†…å®¹ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º
            console.log('ä¿å­˜ã•ã‚ŒãŸãƒãƒˆãƒ«çµæœ:', resultData);
            sessionStorage.setItem('battleResult', JSON.stringify(resultData));
        }
 
        //å…ˆæ”»å¾Œæ”»
        function startBattleTurn() {
            if (isPlayerTurnFirst) {
                alert("ã‚ãªãŸãŒå…ˆè¡Œã§ã™ï¼");
            } else {
                alert("ç›¸æ‰‹ãŒå…ˆè¡Œã§ã™ï¼");
                botTurn(); // ç›¸æ‰‹ã®ã‚¿ãƒ¼ãƒ³ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
            }
        }
 
    </script>
 
</body>
 
</html>
 
 